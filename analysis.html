<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–Ω–¥–µ—Ä–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ —Ä–∏–∑–∏–∫—ñ–≤</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
</head>
<body>
    <main class="container">
        
        <div id="interface-section">
            
            <div class="dropdown">
                <button onclick="toggleMenu()" class="dropbtn">‚ò∞ –ú–µ–Ω—é –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó ‚ñº</button>
                <div id="myDropdown" class="dropdown-content">
                    <a href="index.html">–ì–æ–ª–æ–≤–Ω–∞ (–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è)</a>
                    <a href="report.html">–ê–≥—Ä–µ–≥–æ–≤–∞–Ω—ñ –∑–≤—ñ—Ç–∏</a>
                    <a href="calculator.html">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–æ—Ä–º–∏ –≤–∞–≥–∏</a>
                    <a href="doctor.html">–ö–∞–±—ñ–Ω–µ—Ç –ª—ñ–∫–∞—Ä—è</a>
                    <a href="age_analysis.html">–í—ñ–∫–æ–≤–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</a>
                </div>
            </div>

            <h1>–ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∏–π –ê–Ω–∞–ª—ñ–∑: –ß–æ–ª–æ–≤—ñ–∫–∏ vs –ñ—ñ–Ω–∫–∏</h1>

            <div class="filter-panel" style="text-align: center;">
                <p>–ê–Ω–∞–ª—ñ–∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –Ω–∞ —Å—Ö–∏–ª—å–Ω—ñ—Å—Ç—å –¥–æ –ø—Ä–æ–±–ª–µ–º —ñ–∑ –≤–∞–≥–æ—é.</p>
                <button onclick="runAnalysis()" class="save-btn" style="width: auto;">üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∞–Ω–∞–ª—ñ–∑</button>
            </div>

            <div id="results-block" style="display: none;">
                
                <div class="calc-result-box" id="conclusion-box">
                    <h2 style="margin-top: 0;">–í–∏—Å–Ω–æ–≤–∫–∏ –∞–Ω–∞–ª—ñ–∑—É</h2>
                    <p id="conclusion-text" style="font-size: 1.2em; line-height: 1.5;"></p>
                </div>

                <div class="chart-container">
                    <canvas id="genderChart"></canvas>
                </div>

                <table class="data-table" style="margin-top: 30px;">
                    <thead>
                        <tr>
                            <th>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</th>
                            <th>–ß–æ–ª–æ–≤—ñ–∫–∏ (%)</th>
                            <th>–ñ—ñ–Ω–∫–∏ (%)</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body"></tbody>
                </table>

                <button onclick="printReport()" class="download-btn">üñ®Ô∏è –î—Ä—É–∫—É–≤–∞—Ç–∏ PDF-–∑–≤—ñ—Ç</button>
            </div>
        </div>

        <div id="print-section" class="pdf-template printable-area" style="display: none;">
            <h2 style="text-align: center; color: #2c3e50;">–ó–≤—ñ—Ç –ø—Ä–æ –≥–µ–Ω–¥–µ—Ä–Ω—ñ —Ä–∏–∑–∏–∫–∏ –æ–∂–∏—Ä—ñ–Ω–Ω—è</h2>
            <hr>

            <div style="margin-bottom: 20px;">
                <p><strong>–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É:</strong> <span id="report-date"></span></p>
                <p><strong>–í–∏–±—ñ—Ä–∫–∞:</strong> <span id="total-count"></span> –ø–∞—Ü—ñ—î–Ω—Ç—ñ–≤</p>
            </div>

            <div class="calc-result-box" style="border-color: #3498db; background: #ebf5fb;">
                <h3 style="margin-top: 0; color: #2980b9;">–ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –≤–∏—Å–Ω–æ–≤–æ–∫</h3>
                <p id="print-conclusion-text" style="font-size: 1.1em; font-weight: bold;"></p>
            </div>

            <h3 style="margin-top: 30px;">–í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–æ–∑–ø–æ–¥—ñ–ª—É</h3>
            <div class="chart-container">
                <img id="chart-img-print" alt="–î—ñ–∞–≥—Ä–∞–º–∞ —Ä–æ–∑–ø–æ–¥—ñ–ª—É" style="width: 100%; max-height: 400px; object-fit: contain;">
            </div>

            <div class="footer">
                <p>–ú–µ—Ç–æ–¥: –ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∏–π —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑.</p>
            </div>
        </div>
    </main>

    <script>
        // === –ú–ï–ù–Æ ===
        function toggleMenu() { document.getElementById("myDropdown").classList.toggle("show"); }
        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) openDropdown.classList.remove('show');
                }
            }
        }

        // === –õ–û–ì–Ü–ö–ê –ê–ù–ê–õ–Ü–ó–£ ===
        let myChart = null;

        // –ü–ª–∞–≥—ñ–Ω –¥–ª—è –±—ñ–ª–æ–≥–æ —Ñ–æ–Ω—É –≥—Ä–∞—Ñ—ñ–∫–∞
        const whiteBackgroundPlugin = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart) => {
                const ctx = chart.canvas.getContext('2d');
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        };

        function runAnalysis() {
            const db = getDatabase();
            const validData = db.filter(p => p.height > 0 && p.weight > 0);
            
            if (validData.length === 0) { alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö!"); return; }

            // 1. –°–µ–≥–º–µ–Ω—Ç–∞—Ü—ñ—è —Ç–∞ –ø—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫
            const stats = {
                male: { total: 0, normal: 0, overweight: 0, obesity: 0 },
                female: { total: 0, normal: 0, overweight: 0, obesity: 0 }
            };

            validData.forEach(p => {
                const isMale = (p.gender === '–ß–æ–ª–æ–≤—ñ—á–∞' || p.gender === 'M');
                const group = isMale ? stats.male : stats.female;
                
                group.total++;
                
                if (p.bmi >= 18.5 && p.bmi < 25) group.normal++;
                else if (p.bmi >= 25 && p.bmi < 30) group.overweight++;
                else if (p.bmi >= 30) group.obesity++;
            });

            // 2. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥—Å–æ—Ç–∫—ñ–≤ (–∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—ñ–ª–µ–Ω–Ω—è –Ω–∞ 0)
            const calcPercent = (val, total) => total > 0 ? ((val / total) * 100).toFixed(1) : 0;

            const maleP = {
                normal: calcPercent(stats.male.normal, stats.male.total),
                overweight: calcPercent(stats.male.overweight, stats.male.total),
                obesity: calcPercent(stats.male.obesity, stats.male.total)
            };

            const femaleP = {
                normal: calcPercent(stats.female.normal, stats.female.total),
                overweight: calcPercent(stats.female.overweight, stats.female.total),
                obesity: calcPercent(stats.female.obesity, stats.female.total)
            };

            // 3. –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –≤–∏—Å–Ω–æ–≤–∫—É
            const mObesity = parseFloat(maleP.obesity);
            const fObesity = parseFloat(femaleP.obesity);
            const diff = Math.abs(mObesity - fObesity).toFixed(1);
            
            let conclusion = "";
            if (mObesity > fObesity) {
                conclusion = `–£ –¥–æ—Å–ª—ñ–¥–∂—É–≤–∞–Ω—ñ–π –≤–∏–±—ñ—Ä—Ü—ñ <strong>—á–æ–ª–æ–≤—ñ–∫–∏</strong> –º–∞—é—Ç—å –Ω–∞ <span style="color: #c0392b;">${diff}%</span> –≤–∏—â–∏–π —Ä–∏–∑–∏–∫ –æ–∂–∏—Ä—ñ–Ω–Ω—è, –Ω—ñ–∂ –∂—ñ–Ω–∫–∏.`;
            } else if (fObesity > mObesity) {
                conclusion = `–£ –¥–æ—Å–ª—ñ–¥–∂—É–≤–∞–Ω—ñ–π –≤–∏–±—ñ—Ä—Ü—ñ <strong>–∂—ñ–Ω–∫–∏</strong> –º–∞—é—Ç—å –Ω–∞ <span style="color: #c0392b;">${diff}%</span> –≤–∏—â–∏–π —Ä–∏–∑–∏–∫ –æ–∂–∏—Ä—ñ–Ω–Ω—è, –Ω—ñ–∂ —á–æ–ª–æ–≤—ñ–∫–∏.`;
            } else {
                conclusion = "–†–∏–∑–∏–∫ –æ–∂–∏—Ä—ñ–Ω–Ω—è —É —á–æ–ª–æ–≤—ñ–∫—ñ–≤ —Ç–∞ –∂—ñ–Ω–æ–∫ –æ–¥–Ω–∞–∫–æ–≤–∏–π.";
            }

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è DOM
            document.getElementById('conclusion-text').innerHTML = conclusion;
            document.getElementById('print-conclusion-text').innerHTML = conclusion;
            document.getElementById('report-date').innerText = new Date().toLocaleString('uk-UA');
            document.getElementById('total-count').innerText = validData.length;

            // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
            const tbody = document.getElementById('stats-table-body');
            tbody.innerHTML = `
                <tr><td>–ù–æ—Ä–º–∞ (18.5-25)</td><td>${maleP.normal}%</td><td>${femaleP.normal}%</td></tr>
                <tr><td>–ù–∞–¥–º—ñ—Ä–Ω–∞ –≤–∞–≥–∞ (25-30)</td><td>${maleP.overweight}%</td><td>${femaleP.overweight}%</td></tr>
                <tr style="background: #fdedec; font-weight: bold;"><td>–û–∂–∏—Ä—ñ–Ω–Ω—è (‚â•30)</td><td style="color: #c0392b;">${maleP.obesity}%</td><td style="color: #c0392b;">${femaleP.obesity}%</td></tr>
            `;

            // 4. –ü–æ–±—É–¥–æ–≤–∞ –≥—Ä–∞—Ñ—ñ–∫–∞
            drawGenderChart(maleP, femaleP);
            
            document.getElementById('results-block').style.display = 'block';
        }

        function drawGenderChart(maleP, femaleP) {
            const ctx = document.getElementById('genderChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['–ù–æ—Ä–º–∞', '–ù–∞–¥–º—ñ—Ä–Ω–∞ –≤–∞–≥–∞', '–û–∂–∏—Ä—ñ–Ω–Ω—è'],
                    datasets: [
                        {
                            label: '–ß–æ–ª–æ–≤—ñ–∫–∏',
                            data: [maleP.normal, maleP.overweight, maleP.obesity],
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: '#2980b9',
                            borderWidth: 1
                        },
                        {
                            label: '–ñ—ñ–Ω–∫–∏',
                            data: [femaleP.normal, femaleP.overweight, femaleP.obesity],
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: '#c0392b',
                            borderWidth: 1
                        }
                    ]
                },
                plugins: [whiteBackgroundPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            title: { display: true, text: '–í—ñ–¥—Å–æ—Ç–æ–∫ –≥—Ä—É–ø–∏ (%)' }
                        }
                    },
                    plugins: {
                        title: { display: true, text: '–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –≤–∞–≥–∏ –∑–∞ —Å—Ç–∞—Ç—Ç—é' }
                    }
                }
            });

            // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è –¥—Ä—É–∫—É
            setTimeout(() => {
                const imgData = myChart.toBase64Image();
                document.getElementById('chart-img-print').src = imgData;
            }, 800);
        }

        function printReport() {
            const interfaceSection = document.getElementById('interface-section');
            const printSection = document.getElementById('print-section');
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –ø–µ—Ä–µ–¥ –¥—Ä—É–∫–æ–º
            if (myChart) {
                document.getElementById('chart-img-print').src = myChart.toBase64Image();
            }

            interfaceSection.style.display = 'none';
            printSection.style.display = 'block';

            setTimeout(() => {
                window.print();
                interfaceSection.style.display = 'block';
                printSection.style.display = 'none';
            }, 500);
        }
    </script>
</body>
</html>
