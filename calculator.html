<script>
        // === ПЛАГІН ДЛЯ БІЛОГО ФОНУ (ОБОВ'ЯЗКОВО) ===
        const whiteBackgroundPlugin = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart) => {
                const ctx = chart.canvas.getContext('2d');
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = 'white'; // Робимо фон білим, не прозорим
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        };

        const form = document.getElementById('calc-form');
        let myChart = null;

        function calculateLinearRegression(x, y) {
            const n = x.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += x[i]; sumY += y[i]; sumXY += (x[i] * y[i]); sumXX += (x[i] * x[i]);
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            return { m: slope, b: intercept };
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // 1. Зчитуємо дані
            const gender = form.elements.gender.value;
            const userH = Number(form.elements.height.value);
            const userW = Number(form.elements.weight.value);
            const db = getDatabase();
            const filteredData = db.filter(p => p.gender === gender && p.height > 0 && p.weight > 0);

            if (filteredData.length < 10) { alert("Мало даних!"); return; }

            const xValues = filteredData.map(p => p.height);
            const yValues = filteredData.map(p => p.weight);
            
            // 2. Рахуємо регресію
            const { m, b } = calculateLinearRegression(xValues, yValues);
            const predictedW = (m * userH) + b;
            const diffKg = userW - predictedW;
            const diffPercent = (diffKg / predictedW) * 100;

            // 3. Оновлюємо текст звіту
            document.getElementById('res-gender').innerText = gender;
            document.getElementById('res-height').innerText = userH;
            document.getElementById('res-weight').innerText = userW;
            document.getElementById('db-count').innerText = filteredData.length;
            document.getElementById('report-date').innerText = new Date().toLocaleString('uk-UA');

            document.getElementById('pred-weight').innerText = `${predictedW.toFixed(1)} кг`;
            const sign = diffPercent > 0 ? "+" : "";
            document.getElementById('diff-percent').innerText = `${sign}${diffPercent.toFixed(1)}%`;

            const boxEl = document.getElementById('result-box');
            const textEl = document.getElementById('diff-text');
            boxEl.className = 'calc-result-box'; 
            
            if (Math.abs(diffPercent) <= 10) {
                boxEl.classList.add('result-good');
                textEl.innerText = "У межах норми.";
            } else if (Math.abs(diffPercent) <= 20) {
                boxEl.classList.add('result-warn');
                textEl.innerText = diffPercent > 0 ? "Вище середнього." : "Нижче середнього.";
            } else {
                boxEl.classList.add('result-bad');
                textEl.innerText = "Значне відхилення.";
            }

            // 4. Запускаємо малювання графіка
            renderRegressionChart(xValues, yValues, m, b, userH, userW);
        });

        function renderRegressionChart(xData, yData, m, b, userH, userW) {
            const ctx = document.getElementById('regressionChart').getContext('2d');
            if (myChart) myChart.destroy();

            const scatterData = xData.map((h, i) => ({ x: h, y: yData[i] }));
            const minH = Math.min(...xData);
            const maxH = Math.max(...xData);

            myChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: 'База', data: scatterData, backgroundColor: 'rgba(52, 152, 219, 0.5)', pointRadius: 3 },
                        { label: 'Тренд', data: [{x: minH, y: m*minH+b}, {x: maxH, y: m*maxH+b}], type: 'line', borderColor: 'black', borderWidth: 2, pointRadius: 0, fill: false },
                        { label: 'ВИ', data: [{ x: userH, y: userW }], backgroundColor: 'red', pointRadius: 10, borderColor: 'black', borderWidth: 2 }
                    ]
                },
                plugins: [whiteBackgroundPlugin], // Вмикаємо білий фон
                options: {
                    animation: false, // Без анімації, щоб малювалось миттєво
                    responsive: true,
                    maintainAspectRatio: false,
                    devicePixelRatio: 2, // Висока якість
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: 'Зріст (см)' }, min: 140, max: 210 },
                        y: { title: { display: true, text: 'Вага (кг)' }, min: 40, max: 150 }
                    }
                }
            });

            // === ФІНАЛЬНИЙ ФІКС ДЛЯ ДРУКУ ===
            console.log("Графік створено. Готуємо друк...");

            // Даємо браузеру 0.5 секунди, щоб відрендерити canvas
            setTimeout(() => {
                try {
                    // 1. Конвертуємо графік в картинку (Base64)
                    const imgData = myChart.toBase64Image();
                    
                    // 2. Вставляємо в тег <img>
                    const imgElem = document.getElementById('chart-img-print');
                    imgElem.src = imgData;
                    
                    console.log("Картинку згенеровано. Відкриваємо друк...");

                    // 3. Відкриваємо друк (ще через 0.2с, щоб src точно присвоївся)
                    setTimeout(() => {
                        window.print();
                    }, 200);

                } catch (err) {
                    console.error("Помилка генерації картинки:", err);
                    alert("Помилка при створенні звіту. Спробуйте ще раз.");
                }
            }, 500);
        }
    </script>
