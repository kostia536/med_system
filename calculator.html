<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª—ñ–∑ –≤–∞–≥–∏ (–†–µ–≥—Ä–µ—Å—ñ–π–Ω–∞ –º–æ–¥–µ–ª—å)</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
</head>
<body>
    <main class="container">
        <button onclick="location.href='index.html'" class="nav-btn">‚¨Ö –ù–∞ –≥–æ–ª–æ–≤–Ω—É</button>
        
        <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä "–°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–∞ –ù–æ—Ä–º–∞"</h1>
        
        <form id="calc-form">
            <div class="form-group">
                <label>–í–∞—à–∞ —Å—Ç–∞—Ç—å:
                    <select name="gender" required>
                        <option value="–ß–æ–ª–æ–≤—ñ—á–∞">–ß–æ–ª–æ–≤—ñ–∫</option>
                        <option value="–ñ—ñ–Ω–æ—á–∞">–ñ—ñ–Ω–∫–∞</option>
                    </select>
                </label>
            </div>
            <div class="form-group">
                <label>–í–∞—à –∑—Ä—ñ—Å—Ç (—Å–º): <input type="number" name="height" required min="100" max="250" value="175" /></label>
                <label>–í–∞—à–∞ –≤–∞–≥–∞ (–∫–≥): <input type="number" name="weight" required min="30" max="200" value="75" /></label>
            </div>
            <button type="submit" class="save-btn">üîç –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ç–∞ –î—Ä—É–∫—É–≤–∞—Ç–∏</button>
        </form>

        <div id="pdf-report" class="pdf-template printable-area only-pdf">
            <h2 style="text-align: center; color: #2c3e50;">–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –ó–≤—ñ—Ç</h2>
            <hr style="border: 1px solid #2c3e50;">

            <div style="margin-top: 20px;">
                <h3>1. –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ</h3>
                <table class="pdf-table">
                    <tr>
                        <td><strong>–ü–∞—Ü—ñ—î–Ω—Ç:</strong> –ê–Ω–æ–Ω—ñ–º–Ω–∏–π</td>
                        <td><strong>–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É:</strong> <span id="report-date"></span></td>
                    </tr>
                    <tr>
                        <td><strong>–°—Ç–∞—Ç—å:</strong> <span id="res-gender"></span></td>
                        <td><strong>–ó—Ä—ñ—Å—Ç:</strong> <span id="res-height"></span> —Å–º</td>
                    </tr>
                    <tr>
                        <td><strong>–§–∞–∫—Ç–∏—á–Ω–∞ –≤–∞–≥–∞:</strong> <span id="res-weight"></span> –∫–≥</td>
                        <td></td>
                    </tr>
                </table>
            </div>

            <div style="margin-top: 30px;">
                <h3>2. –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è</h3>
                <p>
                    –ù–∞ –æ—Å–Ω–æ–≤—ñ –ª—ñ–Ω—ñ–π–Ω–æ—ó —Ä–µ–≥—Ä–µ—Å—ñ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (<span id="db-count"></span> –∑–∞–ø–∏—Å—ñ–≤), 
                    –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–∞ "—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–∞ –Ω–æ—Ä–º–∞" –¥–ª—è –≤–∞—à–æ–≥–æ –∑—Ä–æ—Å—Ç—É —Å–∫–ª–∞–¥–∞—î:
                </p>
                
                <div class="calc-result-box" id="result-box">
                    <h1 style="margin: 0; font-size: 3em;" id="pred-weight">-- –∫–≥</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.2em;">
                        –í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è: <strong id="diff-percent">--%</strong>
                    </p>
                    <p id="diff-text" style="font-size: 0.9em;"></p>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3>3. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è</h3>
                <p style="font-size: 0.8em; color: #666;">
                    –°–∏–Ω—ñ —Ç–æ—á–∫–∏ - –±–∞–∑–∞. –ß–µ—Ä–≤–æ–Ω–∞ –ª—ñ–Ω—ñ—è - —Ç—Ä–µ–Ω–¥. <br>
                    <strong>–í–µ–ª–∏–∫–µ —á–µ—Ä–≤–æ–Ω–µ –∫–æ–ª–æ - —Ü–µ –≤–∏.</strong>
                </p>
                
                <div class="chart-container">
                    <canvas id="regressionChart"></canvas>
                    <img id="chart-img-print" alt="–ì—Ä–∞—Ñ—ñ–∫ –∞–Ω–∞–ª—ñ–∑—É">
                </div>
            </div>

            <div class="footer">
                <p>–ú–µ—Ç–æ–¥: –õ—ñ–Ω—ñ–π–Ω–∞ —Ä–µ–≥—Ä–µ—Å—ñ—è (Least Squares). –ù–µ —î –º–µ–¥–∏—á–Ω–∏–º –¥—ñ–∞–≥–Ω–æ–∑–æ–º.</p>
            </div>
        </div>
    </main>

    <script>
        console.log("–°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω–æ!"); // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª—ñ

        const form = document.getElementById('calc-form');
        let myChart = null;

        // –ü–ª–∞–≥—ñ–Ω –¥–ª—è –±—ñ–ª–æ–≥–æ —Ñ–æ–Ω—É (—â–æ–± –≥—Ä–∞—Ñ—ñ–∫ –±—É–ª–æ –≤–∏–¥–Ω–æ –ø—Ä–∏ –¥—Ä—É–∫—É)
        const whiteBackgroundPlugin = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart) => {
                const ctx = chart.canvas.getContext('2d');
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        };

        // –§—É–Ω–∫—Ü—ñ—è —Ä–µ–≥—Ä–µ—Å—ñ—ó
        function calculateLinearRegression(x, y) {
            const n = x.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += x[i]; sumY += y[i]; sumXY += (x[i] * y[i]); sumXX += (x[i] * x[i]);
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            return { m: slope, b: intercept };
        }

        // –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            console.log("–ö–Ω–æ–ø–∫—É –Ω–∞—Ç–∏—Å–Ω—É—Ç–æ, –ø–æ—á–∏–Ω–∞—î–º–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫...");

            const gender = form.elements.gender.value;
            const userH = Number(form.elements.height.value);
            const userW = Number(form.elements.weight.value);

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
            if (typeof getDatabase !== 'function') {
                alert("–ü–æ–º–∏–ª–∫–∞: –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö data.js –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∞!");
                return;
            }

            const db = getDatabase();
            const filteredData = db.filter(p => p.gender === gender && p.height > 0 && p.weight > 0);

            if (filteredData.length < 10) {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö —É –±–∞–∑—ñ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É!");
                return;
            }

            const xValues = filteredData.map(p => p.height);
            const yValues = filteredData.map(p => p.weight);
            
            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
            const { m, b } = calculateLinearRegression(xValues, yValues);
            const predictedW = (m * userH) + b;
            const diffKg = userW - predictedW;
            const diffPercent = (diffKg / predictedW) * 100;

            console.log("–ü—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–∞ –≤–∞–≥–∞:", predictedW);

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è HTML
            document.getElementById('res-gender').innerText = gender;
            document.getElementById('res-height').innerText = userH;
            document.getElementById('res-weight').innerText = userW;
            document.getElementById('db-count').innerText = filteredData.length;
            document.getElementById('report-date').innerText = new Date().toLocaleString('uk-UA');

            document.getElementById('pred-weight').innerText = `${predictedW.toFixed(1)} –∫–≥`;
            
            const sign = diffPercent > 0 ? "+" : "";
            document.getElementById('diff-percent').innerText = `${sign}${diffPercent.toFixed(1)}%`;

            const boxEl = document.getElementById('result-box');
            const textEl = document.getElementById('diff-text');
            
            // –û—á–∏—â–µ–Ω–Ω—è –∫–ª–∞—Å—ñ–≤
            boxEl.className = 'calc-result-box';
            
            if (Math.abs(diffPercent) <= 10) {
                boxEl.classList.add('result-good');
                textEl.innerText = "–í–∞—à–∞ –≤–∞–≥–∞ –≤ –º–µ–∂–∞—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–æ—ó –Ω–æ—Ä–º–∏.";
            } else if (Math.abs(diffPercent) <= 20) {
                boxEl.classList.add('result-warn');
                textEl.innerText = diffPercent > 0 ? "–í–∏—â–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ." : "–ù–∏–∂—á–µ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ.";
            } else {
                boxEl.classList.add('result-bad');
                textEl.innerText = "–ó–Ω–∞—á–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≤—ñ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.";
            }

            // –ú–∞–ª—é—î–º–æ –≥—Ä–∞—Ñ—ñ–∫
            renderRegressionChart(xValues, yValues, m, b, userH, userW);
        });

        function renderRegressionChart(xData, yData, m, b, userH, userW) {
            const ctx = document.getElementById('regressionChart').getContext('2d');
            if (myChart) myChart.destroy();

            const scatterData = xData.map((h, i) => ({ x: h, y: yData[i] }));
            const minH = Math.min(...xData);
            const maxH = Math.max(...xData);

            myChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        { label: '–ë–∞–∑–∞', data: scatterData, backgroundColor: 'rgba(52, 152, 219, 0.5)', pointRadius: 3 },
                        { label: '–¢—Ä–µ–Ω–¥', data: [{x: minH, y: m*minH+b}, {x: maxH, y: m*maxH+b}], type: 'line', borderColor: 'black', borderWidth: 2, pointRadius: 0, fill: false },
                        { label: '–í–ò', data: [{ x: userH, y: userW }], backgroundColor: 'red', pointRadius: 10, borderColor: 'black', borderWidth: 2 }
                    ]
                },
                plugins: [whiteBackgroundPlugin],
                options: {
                    animation: false, // –ë–µ–∑ –∞–Ω—ñ–º–∞—Ü—ñ—ó
                    responsive: true,
                    maintainAspectRatio: false,
                    devicePixelRatio: 2,
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: '–ó—Ä—ñ—Å—Ç (—Å–º)' }, min: 140, max: 210 },
                        y: { title: { display: true, text: '–í–∞–≥–∞ (–∫–≥)' }, min: 40, max: 150 }
                    }
                }
            });

            // –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –¥—Ä—É–∫—É
            console.log("–ì—Ä–∞—Ñ—ñ–∫ —Å—Ç–≤–æ—Ä–µ–Ω–æ. –ß–µ–∫–∞—î–º–æ...");
            
            setTimeout(() => {
                try {
                    const imgData = myChart.toBase64Image();
                    const imgElem = document.getElementById('chart-img-print');
                    imgElem.src = imgData;
                    
                    console.log("–ö–∞—Ä—Ç–∏–Ω–∫—É –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ. –ó–∞–ø—É—Å–∫ –¥—Ä—É–∫—É...");
                    
                    // –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –¥—Ä—É–∫ –¢–Ü–õ–¨–ö–ò –∫–æ–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è
                    imgElem.onload = function() {
                         window.print();
                    };
                    
                    // –°—Ç—Ä–∞—Ö–æ–≤–∫–∞: —è–∫—â–æ onload –Ω–µ —Å–ø—Ä–∞—Ü—é—î —à–≤–∏–¥–∫–æ, –≤—Å–µ –æ–¥–Ω–æ –¥—Ä—É–∫—É—î–º–æ
                    setTimeout(() => window.print(), 500);

                } catch (err) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ –¥—Ä—É–∫—É:", err);
                }
            }, 500);
        }
    </script>
</body>
</html>
