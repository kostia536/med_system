<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª—ñ–∑ –≤–∞–≥–∏ (–†–µ–≥—Ä–µ—Å—ñ–π–Ω–∞ –º–æ–¥–µ–ª—å)</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
</head>
<body>
    <main class="container">
        <button onclick="location.href='index.html'" class="nav-btn">‚¨Ö –ù–∞ –≥–æ–ª–æ–≤–Ω—É</button>
        
        <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä "–°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–∞ –Ω–æ—Ä–º–∞"</h1>
        <p style="text-align: center; color: #666; margin-bottom: 20px;">
            –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –∑ –±–∞–∑–æ—é –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        </p>

        <form id="calc-form">
            <div class="form-group">
                <label>–í–∞—à–∞ —Å—Ç–∞—Ç—å:
                    <select name="gender" required>
                        <option value="–ß–æ–ª–æ–≤—ñ—á–∞">–ß–æ–ª–æ–≤—ñ–∫</option>
                        <option value="–ñ—ñ–Ω–æ—á–∞">–ñ—ñ–Ω–∫–∞</option>
                    </select>
                </label>
            </div>
            <div class="form-group">
                <label>–í–∞—à –∑—Ä—ñ—Å—Ç (—Å–º): <input type="number" name="height" required min="100" max="250" value="175" /></label>
                <label>–í–∞—à–∞ –≤–∞–≥–∞ (–∫–≥): <input type="number" name="weight" required min="30" max="200" value="75" /></label>
            </div>
            <button type="submit" class="save-btn">üîç –ê–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ç–∞ –°—Ç–≤–æ—Ä–∏—Ç–∏ PDF</button>
        </form>

        <div id="pdf-report" class="pdf-template printable-area only-pdf">
            <h2 style="text-align: center; color: #2c3e50;">–Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∏–π –ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –ó–≤—ñ—Ç</h2>
            <hr style="border: 1px solid #2c3e50;">

            <div style="margin-top: 20px;">
                <h3>1. –í—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ</h3>
                <table class="pdf-table">
                    <tr>
                        <td><strong>–ü–∞—Ü—ñ—î–Ω—Ç:</strong> –ê–Ω–æ–Ω—ñ–º–Ω–∏–π</td>
                        <td><strong>–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É:</strong> <span id="report-date"></span></td>
                    </tr>
                    <tr>
                        <td><strong>–°—Ç–∞—Ç—å:</strong> <span id="res-gender"></span></td>
                        <td><strong>–ó—Ä—ñ—Å—Ç:</strong> <span id="res-height"></span> —Å–º</td>
                    </tr>
                    <tr>
                        <td><strong>–§–∞–∫—Ç–∏—á–Ω–∞ –≤–∞–≥–∞:</strong> <span id="res-weight"></span> –∫–≥</td>
                        <td></td>
                    </tr>
                </table>
            </div>

            <div style="margin-top: 30px;">
                <h3>2. –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–¥–µ–ª—é–≤–∞–Ω–Ω—è</h3>
                <p>
                    –ù–∞ –æ—Å–Ω–æ–≤—ñ –ª—ñ–Ω—ñ–π–Ω–æ—ó —Ä–µ–≥—Ä–µ—Å—ñ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö (<span id="db-count"></span> –∑–∞–ø–∏—Å—ñ–≤), 
                    –ø—Ä–æ–≥–Ω–æ–∑–æ–≤–∞–Ω–∞ "—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–∞ –Ω–æ—Ä–º–∞" –¥–ª—è –≤–∞—à–æ–≥–æ –∑—Ä–æ—Å—Ç—É —Å–∫–ª–∞–¥–∞—î:
                </p>
                
                <div class="calc-result-box" id="result-box">
                    <h1 style="margin: 0; font-size: 3em; line-height: 1.2;" id="pred-weight">-- –∫–≥</h1>
                    <p style="margin: 10px 0 0 0; font-size: 1.2em;">
                        –í—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è: <strong id="diff-percent">--%</strong>
                    </p>
                    <p id="diff-text" style="font-size: 0.9em;"></p>
                </div>
            </div>

            <div style="margin-top: 30px;">
                <h3>3. –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è (Scatter Plot + Trend Line)</h3>
                <p style="font-size: 0.8em; color: #666;">
                    –°–∏–Ω—ñ —Ç–æ—á–∫–∏ - –±–∞–∑–∞ –¥–∞–Ω–∏—Ö. –ß–æ—Ä–Ω–∞ –ª—ñ–Ω—ñ—è - —Ç—Ä–µ–Ω–¥. <br>
                    <strong style="color: #e74c3c; font-size: 1.2em;">‚óè –í–µ–ª–∏–∫–∞ —Ç–æ—á–∫–∞</strong> - —Ü–µ –≤–∏.
                </p>
                
                <div class="chart-container">
                    <canvas id="regressionChart"></canvas>
                    
                    <img id="chart-img-print" style="display: none; width: 100%;" alt="–ì—Ä–∞—Ñ—ñ–∫ –∞–Ω–∞–ª—ñ–∑—É">
                </div>
            </div>

            <div class="footer">
                <p>–ú–µ—Ç–æ–¥: –õ—ñ–Ω—ñ–π–Ω–∞ —Ä–µ–≥—Ä–µ—Å—ñ—è (Least Squares). –ù–µ —î –º–µ–¥–∏—á–Ω–∏–º –¥—ñ–∞–≥–Ω–æ–∑–æ–º.</p>
            </div>
        </div>
    </main>

    <script>
        const form = document.getElementById('calc-form');
        let myChart = null;

        function calculateLinearRegression(x, y) {
            const n = x.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += x[i];
                sumY += y[i];
                sumXY += (x[i] * y[i]);
                sumXX += (x[i] * x[i]);
            }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            return { m: slope, b: intercept };
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const gender = form.elements.gender.value;
            const userH = Number(form.elements.height.value);
            const userW = Number(form.elements.weight.value);

            const db = getDatabase();
            const filteredData = db.filter(p => p.gender === gender && p.height > 0 && p.weight > 0);

            if (filteredData.length < 10) {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–∞–Ω–∏—Ö —É –±–∞–∑—ñ –¥–ª—è —Ü—ñ—î—ó —Å—Ç–∞—Ç—ñ!");
                return;
            }

            const xValues = filteredData.map(p => p.height);
            const yValues = filteredData.map(p => p.weight);
            const { m, b } = calculateLinearRegression(xValues, yValues);
            const predictedW = (m * userH) + b;
            
            const diffKg = userW - predictedW;
            const diffPercent = (diffKg / predictedW) * 100;

            // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø–æ–ª—ñ–≤
            document.getElementById('res-gender').innerText = gender;
            document.getElementById('res-height').innerText = userH;
            document.getElementById('res-weight').innerText = userW;
            document.getElementById('db-count').innerText = filteredData.length;
            document.getElementById('report-date').innerText = new Date().toLocaleString('uk-UA');

            const predEl = document.getElementById('pred-weight');
            const diffEl = document.getElementById('diff-percent');
            const textEl = document.getElementById('diff-text');
            const boxEl = document.getElementById('result-box');

            predEl.innerText = `${predictedW.toFixed(1)} –∫–≥`;
            const sign = diffPercent > 0 ? "+" : "";
            diffEl.innerText = `${sign}${diffPercent.toFixed(1)}%`;

            // –°–∫–∏–¥–∞–Ω–Ω—è –∫–ª–∞—Å—ñ–≤ –ø–µ—Ä–µ–¥ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º –Ω–æ–≤–∏—Ö
            boxEl.className = 'calc-result-box';
            if (Math.abs(diffPercent) <= 10) {
                boxEl.classList.add('result-good');
                textEl.innerText = "–í–∞—à–∞ –≤–∞–≥–∞ –≤ –º–µ–∂–∞—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–æ—ó –Ω–æ—Ä–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö.";
            } else if (Math.abs(diffPercent) <= 20) {
                boxEl.classList.add('result-warn');
                textEl.innerText = diffPercent > 0 ? "–í–∏—â–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ." : "–ù–∏–∂—á–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ.";
            } else {
                boxEl.classList.add('result-bad');
                textEl.innerText = "–ó–Ω–∞—á–Ω–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–Ω—è –≤—ñ–¥ —Ç—Ä–µ–Ω–¥—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö.";
            }

            // –ú–∞–ª—é—î–º–æ –≥—Ä–∞—Ñ—ñ–∫
            renderRegressionChart(xValues, yValues, m, b, userH, userW);
        });

        function renderRegressionChart(xData, yData, m, b, userH, userW) {
            const ctx = document.getElementById('regressionChart').getContext('2d');
            if (myChart) myChart.destroy();

            const scatterData = xData.map((h, i) => ({ x: h, y: yData[i] }));
            const minH = Math.min(...xData);
            const maxH = Math.max(...xData);
            const lineData = [
                { x: minH, y: m * minH + b },
                { x: maxH, y: m * maxH + b }
            ];

            myChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '–ë–∞–∑–∞',
                            data: scatterData,
                            backgroundColor: 'rgba(52, 152, 219, 0.4)',
                            pointRadius: 3
                        },
                        {
                            label: '–¢—Ä–µ–Ω–¥',
                            data: lineData,
                            type: 'line',
                            borderColor: 'rgba(44, 62, 80, 0.9)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: '–í–ò',
                            data: [{ x: userH, y: userW }],
                            backgroundColor: '#e74c3c',
                            pointRadius: 10,
                            pointHoverRadius: 12,
                            borderColor: 'white',
                            borderWidth: 3
                        }
                    ]
                },
                options: {
                    animation: false, // –í–ò–ú–ò–ö–ê–Ñ–ú–û –∞–Ω—ñ–º–∞—Ü—ñ—é
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: '–ì—Ä–∞—Ñ—ñ–∫ –†–µ–≥—Ä–µ—Å—ñ—ó' }
                    },
                    scales: {
                        x: { type: 'linear', position: 'bottom', title: { display: true, text: '–ó—Ä—ñ—Å—Ç (—Å–º)' }, min: 140, max: 210 },
                        y: { title: { display: true, text: '–í–∞–≥–∞ (–∫–≥)' }, min: 40, max: 150 }
                    }
                }
            });

            // === –§–Ü–ö–° –î–õ–Ø –î–†–£–ö–£ ===
            // –ß–µ–∫–∞—î–º–æ —Ç—Ä–æ—Ö–∏, –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≥—Ä–∞—Ñ—ñ–∫ –≤ –∫–∞—Ä—Ç–∏–Ω–∫—É —ñ –≤–∏–∫–ª–∏–∫–∞—î–º–æ –¥—Ä—É–∫
            setTimeout(() => {
                const imgData = myChart.toBase64Image();
                const imgElem = document.getElementById('chart-img-print');
                imgElem.src = imgData;
                
                // –¢—ñ–ª—å–∫–∏ —Ç–µ–ø–µ—Ä –¥—Ä—É–∫—É—î–º–æ
                window.print();
            }, 800);
        }
    </script>
</body>
</html>
