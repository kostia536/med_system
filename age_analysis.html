<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—ñ–∫–æ–≤–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ –Ü–ú–¢</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="data.js"></script>
</head>
<body>
    <main class="container">
        
        <div id="interface-section">
            
            <div class="dropdown">
                <button onclick="toggleMenu()" class="dropbtn">‚ò∞ –ú–µ–Ω—é –Ω–∞–≤—ñ–≥–∞—Ü—ñ—ó ‚ñº</button>
                <div id="myDropdown" class="dropdown-content">
                    <a href="index.html">–ì–æ–ª–æ–≤–Ω–∞ (–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è)</a>
                    <a href="report.html">–ê–≥—Ä–µ–≥–æ–≤–∞–Ω—ñ –∑–≤—ñ—Ç–∏</a>
                    <a href="calculator.html">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–æ—Ä–º–∏ –≤–∞–≥–∏</a>
                    <a href="doctor.html">–ö–∞–±—ñ–Ω–µ—Ç –ª—ñ–∫–∞—Ä—è</a>
                    <a href="analysis.html">–ì–µ–Ω–¥–µ—Ä–Ω–∏–π –∞–Ω–∞–ª—ñ–∑</a>
                </div>
            </div>

            <h1>–ê–Ω–∞–ª—ñ–∑ —Ç—Ä–µ–Ω–¥—ñ–≤: –≤—ñ–∫ —Ç–∞ –Ü–ú–¢</h1>

            <div class="filter-panel" style="text-align: center;">
                <p>–î–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –∫–æ—Ä–µ–ª—è—Ü—ñ—ó –º—ñ–∂ –≤—ñ–∫–æ–º —Ç–∞ —ñ–Ω–¥–µ–∫—Å–æ–º –º–∞—Å–∏ —Ç—ñ–ª–∞.</p>
                <button onclick="runAgeAnalysis()" class="save-btn" style="width: auto; background-color: #8e44ad;">üìâ –ü–æ–±—É–¥—É–≤–∞—Ç–∏ —Ç—Ä–µ–Ω–¥</button>
            </div>

            <div id="results-block" style="display: none;">
                
                <div class="calc-result-box" id="conclusion-box" style="border-color: #8e44ad; background-color: #f4ecf7;">
                    <h2 style="margin-top: 0; color: #6c3483;">–ì—Ä—É–ø–∞ –ø—ñ–¥–≤–∏—â–µ–Ω–æ–≥–æ —Ä–∏–∑–∏–∫—É</h2>
                    <p id="conclusion-text" style="font-size: 1.2em; line-height: 1.5;"></p>
                </div>

                <div class="chart-container">
                    <canvas id="ageChart"></canvas>
                </div>

                <table class="data-table" style="margin-top: 30px;">
                    <thead>
                        <tr>
                            <th>–í—ñ–∫–æ–≤–∞ –∫–æ–≥–æ—Ä—Ç–∞</th>
                            <th>–ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–∞—Ü—ñ—î–Ω—Ç—ñ–≤</th>
                            <th>–°–µ—Ä–µ–¥–Ω—ñ–π –Ü–ú–¢</th>
                            <th>–°—Ç–∞—Ç—É—Å –≥—Ä—É–ø–∏</th>
                        </tr>
                    </thead>
                    <tbody id="stats-table-body"></tbody>
                </table>

                <button onclick="printReport()" class="download-btn">üñ®Ô∏è –î—Ä—É–∫—É–≤–∞—Ç–∏ PDF-–∑–≤—ñ—Ç</button>
            </div>
        </div>

        <div id="print-section" class="pdf-template printable-area" style="display: none;">
            <h2 style="text-align: center; color: #2c3e50;">–ó–≤—ñ—Ç: –≤—ñ–∫–æ–≤–∞ –¥–∏–Ω–∞–º—ñ–∫–∞ –Ü–ú–¢</h2>
            <hr>

            <div style="margin-bottom: 20px;">
                <p><strong>–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É:</strong> <span id="report-date"></span></p>
                <p><strong>–í—Å—å–æ–≥–æ –æ–±—Ä–æ–±–ª–µ–Ω–æ:</strong> <span id="total-count"></span> –ø–∞—Ü—ñ—î–Ω—Ç—ñ–≤</p>
            </div>

            <div class="calc-result-box" style="border-color: #8e44ad; background: #f4ecf7;">
                <h3 style="margin-top: 0; color: #6c3483;">–ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –≤–∏—Å–Ω–æ–≤–æ–∫</h3>
                <p id="print-conclusion-text" style="font-size: 1.1em; font-weight: bold;"></p>
            </div>

            <h3 style="margin-top: 30px;">–ì—Ä–∞—Ñ—ñ–∫ —Ç—Ä–µ–Ω–¥—É</h3>
            <div class="chart-container">
                <img id="chart-img-print" alt="–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–∫–æ–≤–æ–≥–æ —Ç—Ä–µ–Ω–¥—É" style="width: 100%; max-height: 400px; object-fit: contain;">
            </div>

            <h3 style="margin-top: 20px;">–î–µ—Ç–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <table class="data-table" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #000; padding: 5px;">–í—ñ–∫–æ–≤–∞ –∫–æ–≥–æ—Ä—Ç–∞</th>
                        <th style="border: 1px solid #000; padding: 5px;">–ö—ñ–ª—å–∫—ñ—Å—Ç—å</th>
                        <th style="border: 1px solid #000; padding: 5px;">–°–µ—Ä–µ–¥–Ω—ñ–π –Ü–ú–¢</th>
                        <th style="border: 1px solid #000; padding: 5px;">–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="print-stats-table-body"></tbody>
            </table>

            <div class="footer">
                <p>–ú–µ—Ç–æ–¥: –ö–æ–≥–æ—Ä—Ç–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ —Å–µ—Ä–µ–¥–Ω—ñ—Ö –≤–µ–ª–∏—á–∏–Ω.</p>
            </div>
        </div>
    </main>

    <script>
        function toggleMenu() { document.getElementById("myDropdown").classList.toggle("show"); }
        window.onclick = function(event) {
            if (!event.target.matches('.dropbtn')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) openDropdown.classList.remove('show');
                }
            }
        }

        let myChart = null;
        const whiteBackgroundPlugin = {
            id: 'customCanvasBackgroundColor',
            beforeDraw: (chart) => {
                const ctx = chart.canvas.getContext('2d');
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        };

        function runAgeAnalysis() {
            const db = getDatabase();
            const currentYear = new Date().getFullYear();
            
            const cohorts = {
                '18-35': { label: '–ú–æ–ª–æ–¥—å (18-35)', sumBMI: 0, count: 0 },
                '36-50': { label: '–°–µ—Ä–µ–¥–Ω—ñ–π –≤—ñ–∫ (36-50)', sumBMI: 0, count: 0 },
                '51-65': { label: '–ó—Ä—ñ–ª–∏–π –≤—ñ–∫ (51-65)', sumBMI: 0, count: 0 },
                '65+':   { label: '–õ—ñ—Ç–Ω—ñ –ª—é–¥–∏ (65+)', sumBMI: 0, count: 0 }
            };

            let validCount = 0;

            db.forEach(p => {
                if (p.height > 0 && p.weight > 0 && p.birthYear > 1900) {
                    const age = currentYear - p.birthYear;
                    const bmi = p.weight / ((p.height/100)**2);
                    
                    let groupKey = '';
                    if (age >= 18 && age <= 35) groupKey = '18-35';
                    else if (age >= 36 && age <= 50) groupKey = '36-50';
                    else if (age >= 51 && age <= 65) groupKey = '51-65';
                    else if (age > 65) groupKey = '65+';

                    if (groupKey) {
                        cohorts[groupKey].sumBMI += bmi;
                        cohorts[groupKey].count++;
                        validCount++;
                    }
                }
            });

            if (validCount === 0) { alert("–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É!"); return; }

            const labels = [];
            const dataPoints = [];
            let maxBMI = 0;
            let riskGroup = '';

            // –û—á–∏—â–∞—î–º–æ –æ–±–∏–¥–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ (–µ–∫—Ä–∞–Ω–Ω—É —ñ –¥—Ä—É–∫–æ–≤–∞–Ω—É)
            const tbody = document.getElementById('stats-table-body');
            const printTbody = document.getElementById('print-stats-table-body');
            tbody.innerHTML = '';
            printTbody.innerHTML = '';

            for (const key in cohorts) {
                const group = cohorts[key];
                const avgBMI = group.count > 0 ? (group.sumBMI / group.count).toFixed(2) : 0;
                
                labels.push(key);
                dataPoints.push(avgBMI);

                if (parseFloat(avgBMI) > maxBMI) {
                    maxBMI = parseFloat(avgBMI);
                    riskGroup = group.label;
                }

                let status = '–ù–æ—Ä–º–∞';
                let color = 'green';
                if (avgBMI >= 25 && avgBMI < 30) { status = '–ù–∞–¥–º—ñ—Ä–Ω–∞ –≤–∞–≥–∞'; color = '#f39c12'; }
                if (avgBMI >= 30) { status = '–û–∂–∏—Ä—ñ–Ω–Ω—è'; color = '#c0392b'; }

                // HTML —Ä—è–¥–∫–∞
                const rowHTML = `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 5px;">${group.label}</td>
                        <td style="border: 1px solid #ddd; padding: 5px;">${group.count}</td>
                        <td style="border: 1px solid #ddd; padding: 5px;"><strong>${avgBMI}</strong></td>
                        <td style="border: 1px solid #ddd; padding: 5px; color: ${color}; font-weight: bold;">${status}</td>
                    </tr>
                `;

                // –î–æ–¥–∞—î–º–æ –≤ –æ–±–∏–¥–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ
                tbody.innerHTML += rowHTML;
                printTbody.innerHTML += rowHTML;
            }

            const conclusion = `–ù–∞ –æ—Å–Ω–æ–≤—ñ –∞–Ω–∞–ª—ñ–∑—É –≤–∏–±—ñ—Ä–∫–∏, –Ω–∞–π–±—ñ–ª—å—à –≤—Ä–∞–∑–ª–∏–≤–æ—é —î –≥—Ä—É–ø–∞ <strong>"${riskGroup}"</strong> —ñ–∑ —Å–µ—Ä–µ–¥–Ω—ñ–º –ø–æ–∫–∞–∑–Ω–∏–∫–æ–º –Ü–ú–¢ <span style="color: #c0392b; font-size: 1.2em;">${maxBMI}</span>.`;
            
            document.getElementById('conclusion-text').innerHTML = conclusion;
            document.getElementById('print-conclusion-text').innerHTML = conclusion;
            document.getElementById('report-date').innerText = new Date().toLocaleString('uk-UA');
            document.getElementById('total-count').innerText = validCount;

            drawAgeChart(labels, dataPoints);
            document.getElementById('results-block').style.display = 'block';
        }

        function drawAgeChart(labels, data) {
            const ctx = document.getElementById('ageChart').getContext('2d');
            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '–°–µ—Ä–µ–¥–Ω—ñ–π –Ü–ú–¢',
                        data: data,
                        borderColor: '#8e44ad',
                        backgroundColor: 'rgba(142, 68, 173, 0.2)',
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#8e44ad',
                        pointRadius: 6,
                        fill: true,
                        tension: 0.3
                    }]
                },
                plugins: [whiteBackgroundPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: false, min: 15, title: { display: true, text: '–Ü–Ω–¥–µ–∫—Å –º–∞—Å–∏ —Ç—ñ–ª–∞ (–Ü–ú–¢)' } },
                        x: { title: { display: true, text: '–í—ñ–∫–æ–≤—ñ –≥—Ä—É–ø–∏' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            setTimeout(() => {
                const imgData = myChart.toBase64Image();
                document.getElementById('chart-img-print').src = imgData;
            }, 800);
        }

        function printReport() {
            const interfaceSection = document.getElementById('interface-section');
            const printSection = document.getElementById('print-section');
            
            if (myChart) {
                document.getElementById('chart-img-print').src = myChart.toBase64Image();
            }

            interfaceSection.style.display = 'none';
            printSection.style.display = 'block';

            setTimeout(() => {
                window.print();
                interfaceSection.style.display = 'block';
                printSection.style.display = 'none';
            }, 500);
        }
    </script>
</body>
</html>
